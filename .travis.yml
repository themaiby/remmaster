language: php
php:
  - '7.3'
node_js:
  - '10'

services:
  - redis-server
  - postgresql

postgres:
  adapter: postgresql
  database: test
  username: postgres

before_install:
  - composer global require hirak/prestissimo
  - psql -c 'create database test;' -U postgres

install:
  - cp .env.example .env
  - composer self-update
  - composer install --no-interaction
  - php artisan key:generate
  - php artisan jwt:secret -f
  - php artisan migrate --seed
  - npm install
  - npm run prod

after_success:
  - composer install --no-dev
  - rm -rf node_modules/
  - rm -rf resources/js/
  - rm -rf tests/
  - rm .env
  - rm .env.test
  - rm .babelrc
  - rm .editorconfig
  - rm .eslintrc.js
  - rm .gitattributes
  - rm .gitignore
  - rm .travis.yml
  - rm Vagrantfile
  - rm after.sh
  - rm aliases
  - rm composer.json
  - rm composer.lock
  - rm package-lock.json
  - rm package.json
  - rm phpunit.xml
  - rm tsconfig.json
  - rm webpack.mix.js

before_deploy:
  - cd ..
  - tar -zcf ${TRAVIS_BUILD_DIR}${REPO}-${BUILD_ENV}-${TRAVIS_TAG}-${TRAVIS_BUILD_NUMBER}.tar.gz ${REPO}

deploy:
  - provider: s3
    bucket: '$ARTIFACTS_BUCKET'
    access_key_id: '$ARTIFACTS_KEY'
    secret_access_key: '$ARTIFACTS_SECRET'
    upload-dir: 'build/dev'
    file: '${TRAVIS_BUILD_DIR}${REPO}-${BUILD_ENV}-${TRAVIS_TAG}-${TRAVIS_BUILD_NUMBER}.tar.gz'
    region: 'eu-central-1'
    skip_cleanup: true
    on:
      branch: 'dev'
  - provider: s3
    bucket: '$ARTIFACTS_BUCKET'
    access_key_id: '$ARTIFACTS_KEY'
    secret_access_key: '$ARTIFACTS_SECRET'
    upload-dir: 'build/master'
    file: '${TRAVIS_BUILD_DIR}${REPO}-${BUILD_ENV}-${TRAVIS_TAG}-${TRAVIS_BUILD_NUMBER}.tar.gz'
    region: 'eu-central-1'
    skip_cleanup: true
    on:
      branch: 'master'
  - provider: releases
    api_key: '$GITHUB_API'
    file: ${TRAVIS_BUILD_DIR}${REPO}-${BUILD_ENV}-${TRAVIS_TAG}-${TRAVIS_BUILD_NUMBER}.tar.gz
    skip_cleanup: true
    on:
      tags: true

notifications:
  email:
    recipients:
      - themaiby0@gmail.com
    on_failure: always
    on_success: never
